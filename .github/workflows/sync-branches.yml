name: Sync Remote Branches

on:
  schedule:
    - cron: '0 */6 * * *'  # æ¯6å°æ—¶åŒæ­¥ä¸€æ¬¡
  workflow_dispatch:        # æ”¯æŒæ‰‹åŠ¨è§¦å‘
  repository_dispatch:      # æ”¯æŒAPIè§¦å‘
    types: [sync-requested]

jobs:
  sync-remote:
    runs-on: ubuntu-latest
    strategy:
      matrix:
        branches: ['main']  # éœ€è¦åŒæ­¥çš„åˆ†æ”¯åˆ—è¡¨
    permissions:
      contents: write  # éœ€è¦å†™æƒé™æ¨é€åˆ†æ”¯
      
    steps:
      - name: æ£€å‡ºå½“å‰ä»“åº“
        uses: actions/checkout@v4
        with:
          ref: ${{ matrix.branches }}
          fetch-depth: 0

      - name: æ·»åŠ ä¸Šæ¸¸ä»“åº“
        run: |
          git remote add upstream https://github.com/${{ env.UPSTREAM_REPO }}.git
          git fetch upstream --prune
        env:
          UPSTREAM_REPO: ymyuuu/IPDB  # æ›¿æ¢ä¸ºçœŸå®ä¸Šæ¸¸ä»“åº“

      - name: å°è¯•åŒæ­¥åˆ†æ”¯
        id: sync
        run: |
          # å°è¯•åˆå¹¶ä¸Šæ¸¸åˆ†æ”¯
          git checkout ${{ matrix.branches }}
          if git merge --no-commit --no-ff upstream/${{ matrix.branches }}; then
            echo "status=success" >> $GITHUB_OUTPUT
          else
            # å¤„ç†å†²çª
            git merge --abort
            echo "status=conflict" >> $GITHUB_OUTPUT
            echo "conflict_files=$(git diff --name-only --diff-filter=U | tr '\n' ',')" >> $GITHUB_OUTPUT
          fi

      - name: æ¨é€æ›´æ–°
        if: steps.sync.outputs.status == 'success'
        run: |
          git config user.name "GitHub Sync Bot"
          git config user.email "actions@github.com"
          git commit -m "ğŸ” è‡ªåŠ¨åŒæ­¥ä¸Šæ¸¸åˆ†æ”¯: ${{ matrix.branches }} [skip ci]"
          git push origin ${{ matrix.branches }}

      - name: å†²çªå¤„ç†
        if: steps.sync.outputs.status == 'conflict'
        uses: actions/github-script@v7
        with:
          script: |
            const branch = '${{ matrix.branches }}';
            const conflictFiles = '${{ steps.sync.outputs.conflict_files }}'.split(',');
            
            // åˆ›å»ºå†²çªæŠ¥å‘Šissue
            await github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: `åˆ†æ”¯åŒæ­¥å†²çª: ${branch}`,
              body: `âš ï¸ æ— æ³•è‡ªåŠ¨åŒæ­¥åˆ†æ”¯ ${branch}\n\n` +
                     `**å†²çªæ–‡ä»¶**:\n${conflictFiles.map(f => `- ${f}`).join('\n')}\n\n` +
                     `[ç‚¹å‡»è§£å†³å†²çª](${process.env.GITHUB_SERVER_URL}/${context.repo.owner}/${context.repo.repo}/compare/${branch}...upstream/${branch})`,
              labels: ['sync-conflict']
            });
            
            // æ·»åŠ åˆ†æ”¯ä¿æŠ¤æ³¨é‡Š
            await github.rest.repos.createCommitComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              commit_sha: context.sha,
              body: `åˆ†æ”¯åŒæ­¥å¤±è´¥ï¼å­˜åœ¨å†²çªéœ€è¦æ‰‹åŠ¨è§£å†³ã€‚`
            });

      - name: å‘é€é€šçŸ¥
        if: always()
        uses: actions-slack@v3
        with:
          status: ${{ steps.sync.outputs.status }}
          fields: repo,branch,status
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK }}
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
