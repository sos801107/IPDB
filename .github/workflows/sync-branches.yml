name: Sync Upstream Repository

on:
  schedule:
    - cron: '0 0 * * *'  # æ¯å¤© UTC åˆå¤œåŒæ­¥ä¸€æ¬¡
  workflow_dispatch:      # æ”¯æŒæ‰‹åŠ¨è§¦å‘
  repository_dispatch:    # æ”¯æŒAPIè§¦å‘
    types: [sync-requested]

jobs:
  sync-upstream:
    runs-on: ubuntu-latest
    permissions:
      contents: write  # éœ€è¦å†™æƒé™æ¨é€åˆ†æ”¯
      pull-requests: write
      issues: write

    steps:
      - name: æ£€å‡ºå½“å‰ä»“åº“
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # è·å–å®Œæ•´å†å²

      - name: é…ç½® Git èº«ä»½
        run: |
          git config user.name "GitHub Upstream Sync Bot"
          git config user.email "actions@github.com"

      - name: æ·»åŠ ä¸Šæ¸¸ä»“åº“
        run: |
          git remote add upstream https://github.com/${{ env.UPSTREAM_REPO }}.git
          git fetch upstream --prune
        env:
          UPSTREAM_REPO: "ymyuuu/IPDB"  # æ›¿æ¢ä¸ºçœŸå®ä¸Šæ¸¸ä»“åº“

      - name: è·å–éœ€è¦åŒæ­¥çš„åˆ†æ”¯
        id: get-branches
        run: |
          # è·å–ä¸Šæ¸¸æ‰€æœ‰åˆ†æ”¯
          UPSTREAM_BRANCHES=$(git ls-remote --heads upstream | awk '{print $2}' | sed 's/refs\/heads\///')
          
          # è·å–å½“å‰ä»“åº“åˆ†æ”¯
          CURRENT_BRANCHES=$(git branch -r | grep -v 'HEAD' | sed 's/origin\///')
          
          # æ‰¾å‡ºéœ€è¦åŒæ­¥çš„åˆ†æ”¯ï¼ˆä¸Šæ¸¸å­˜åœ¨ä¸”å½“å‰ä»“åº“ä¹Ÿå­˜åœ¨ï¼‰
          SYNC_BRANCHES=$(comm -12 <(echo "$UPSTREAM_BRANCHES" | sort) <(echo "$CURRENT_BRANCHES" | sort) | tr '\n' ' ')
          
          echo "éœ€è¦åŒæ­¥çš„åˆ†æ”¯: $SYNC_BRANCHES"
          echo "sync_branches=$SYNC_BRANCHES" >> $GITHUB_OUTPUT
        shell: bash

      - name: åŒæ­¥åˆ†æ”¯
        id: sync-branches
        run: |
          # å°†åˆ†æ”¯åˆ—è¡¨è½¬æ¢ä¸ºæ•°ç»„
          IFS=' ' read -ra BRANCHES <<< "${{ steps.get-branches.outputs.sync_branches }}"
          
          # åˆå§‹åŒ–ç»“æœå˜é‡
          SUCCESS_BRANCHES=""
          FAILED_BRANCHES=""
          CONFLICT_BRANCHES=""
          
          for branch in "${BRANCHES[@]}"; do
            echo "æ­£åœ¨åŒæ­¥åˆ†æ”¯: $branch"
            
            # æ£€å‡ºåˆ†æ”¯
            git checkout -B $branch origin/$branch
            
            # å°è¯•åˆå¹¶ä¸Šæ¸¸æ›´æ”¹
            if git merge --no-commit --no-ff upstream/$branch; then
              git commit -m "ğŸ” è‡ªåŠ¨åŒæ­¥ä¸Šæ¸¸æ›´æ”¹: $branch [skip ci]"
              git push origin $branch
              SUCCESS_BRANCHES+="$branch "
              echo "âœ… $branch åŒæ­¥æˆåŠŸ"
            else
              # å¤„ç†å†²çª
              git merge --abort
              
              # åˆ›å»ºå†²çªè§£å†³åˆ†æ”¯
              CONFLICT_BRANCH="sync-conflict-$branch-$(date +%s)"
              git checkout -b $CONFLICT_BRANCH
              git push origin $CONFLICT_BRANCH
              
              # åˆ›å»ºPR
              PR_URL=$(gh pr create --base $branch --head $CONFLICT_BRANCH \
                --title "è§£å†³ä¸Šæ¸¸åŒæ­¥å†²çª: $branch" \
                --body "ä¸Šæ¸¸åŒæ­¥æ—¶æ£€æµ‹åˆ°å†²çªï¼Œè¯·æ‰‹åŠ¨è§£å†³ã€‚\n\nå†²çªæ–‡ä»¶:\n$(git diff --name-only --diff-filter=U)")
              
              FAILED_BRANCHES+="$branch "
              CONFLICT_BRANCHES+="$branch:$PR_URL "
              echo "âŒ $branch åŒæ­¥å¤±è´¥ï¼Œåˆ›å»ºå†²çªè§£å†³PR: $PR_URL"
            fi
          done
          
          # è®¾ç½®è¾“å‡ºå˜é‡
          echo "success_branches=$SUCCESS_BRANCHES" >> $GITHUB_OUTPUT
          echo "failed_branches=$FAILED_BRANCHES" >> $GITHUB_OUTPUT
          echo "conflict_branches=$CONFLICT_BRANCHES" >> $GITHUB_OUTPUT
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}


      - name: Slack é€šçŸ¥
        if: ${{ steps.sync-branches.outputs.failed_branches != '' }}
        uses: slackapi/slack-github-action@v1.24.0
        with:
          channel-id: 'C123456'  # æ›¿æ¢ä¸ºçœŸå®é¢‘é“ID
          slack-message: |
            :arrows_counterclockwise: *ä¸Šæ¸¸åŒæ­¥æŠ¥å‘Š*
            ${{ github.repository }} â†’ ${{ env.UPSTREAM_REPO }}
            :white_check_mark: æˆåŠŸåˆ†æ”¯: ${{ steps.sync-branches.outputs.success_branches || 'æ— ' }}
            :x: å¤±è´¥åˆ†æ”¯: ${{ steps.sync-branches.outputs.failed_branches || 'æ— ' }}
            :warning: å†²çªè§£å†³PR: ${{ steps.sync-branches.outputs.conflict_branches || 'æ— ' }}
        env:
          SLACK_TOKEN: ${{ secrets.SLACK_BOT_TOKEN }}
